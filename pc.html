<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=0">
<title>問題画面 - Quiz</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<link href="src/css/quiz.css" rel="stylesheet">
<style>
[v-cloak] { display:none }
meter {
    border: 1px solid #ccc;
    width: 600px; height: 20px;
    box-shadow: 0px 0px 10px rgba(0,0,0,.1);
}

section { width: 600px; margin: 0 auto;}

</style>
</head>
<body>

<header class="header">
    <h1>Quiz</h1>
</header>

<main v-cloak>

    <section class="quiz" v-if="scrn.s1">
        <h2>リアルタイム早押しクイズゲーム</h2>
        <h3>ルール</h3>
        <p>サインインしたら、クイズが始まるまで、しばらくお待ちください。</p>
        <p>クイズが開始されたら、お持ちのスマホ端末から正解だと思うボタンを押してね。</p>
        <p>＜クイズおじさんをこの辺に入れたい＞</p>
        <button class="quiz__btn btn btn-default" v-on="click: openQ()">始める！</button>
    </section>

    <section class="quiz" v-if="scrn.s2">
        <h2 v-show="num" class="quiz__num">Q.{{num}}</h2>
        <p class="quiz__title">{{quiz}}</p>
        <button class="quiz__btn btn btn-default" v-on="click: startQ()">クイズスタート！</button>
    </section>

    <section class="quiz" v-if="scrn.s3">
        <h2 v-show="num" class="quiz__num">Q.{{num}}</h2>
        <p class="quiz__title">{{quiz}}</p>
        <ol class="quiz__answer">
           <li v-repeat="ex">{{$value}}</li>
        </ol>
        <div>
            <meter value="{{nowTime * (100 / setTime)}}" low="30" high="60" optimum="100" max="100"></meter> <br>
            <time>{{nowTime}}秒</time>
        </div>
    </section>

    <section class="quiz" v-if="scrn.s4">
        <h2 class="quiz__title">ランキング</h2>
        <ol class="quiz__ranking">
            <li>k-morita</li>
            <li>sao-murakami</li>
            <li>y-nishino</li>
            <li>k-konno</li>
        </ol>
        <button class="quiz__btn btn btn-default" v-on="click: changeQ()" v-attr="disabled: disabled">次の問題へ</button>
    </section>

</main>

<footer class="footer">
    <p>©MeHerBu</p>
</footer>

<audio src="src/audio/mondai_girl.webm" autoplay loop preload="auto" id="audio_bgm"></audio>
<audio src="src/audio/thinking.webm" loop preload="auto" id="audio_thinking"></audio>

<script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/vue/0.10.5/vue.min.js"></script>
<script src='https://cdn.mlkcca.com/v2.0.0/milkcocoa.js'></script>
<script src="src/js/app.js"></script>
<script>
// --------------------------------------------------------
// Setting
// --------------------------------------------------------
var intervalTime = 1000; // 1秒
var countTime = 5;
var sec = countTime;
var nowScrn = 's1'; // 初回スクリーン名
var timer;

// オーディオ
var El_audioBgm = document.getElementById('audio_bgm');
var El_audioThinking = document.getElementById('audio_thinking');
// 音量
El_audioBgm.volume = 1;
El_audioThinking.volume = 0.2;

// --------------------------------------------------------
// View
// --------------------------------------------------------
var vue = new Vue({
    el: 'main',
    data: {
        num: '',
        quiz: '',
        ex: '',
        setTime: countTime,
        nowTime: sec,
        disabled: '',
        scrn : {
            s1 : true,
            s2 : false,
            s3 : false,
            s4 : false
        }
    },

    methods:{
        // JSONを取得
        getJson: function(){
            $.getJSON(jsonPath).done(function(data){
                qaJson = data;
                getObjLength(qaJson);
            });
        },

        // 次の画面に切り替え
        toScrn: function(nextScrn){
            this.$set('scrn.' + nowScrn, false);
            this.$set('scrn.' + nextScrn, true);
            nowScrn = nextScrn;
        },

        // 問題表示画面へ
        openQ: function(){
            vue.changeQ(qaJson);
            vue.toScrn('s2');
        },

        // 問題スタート
        startQ: function(){
            vue.countStart();
            vue.toScrn('s3');
        },

        // ランキング画面へ
        rankingQ: function(){
            vue.toScrn('s4');

            El_audioBgm.play();
            El_audioThinking.pause();
            El_audioThinking.currentTime = 0;
        },

        // 次の問題へ
        changeQ: function(){
            ++actNum;

            // 次の問題をデータバインド
            if(actNum <= maxNum) {
                this.$set('num', actNum);
                this.$set('quiz', qaJson['q' + actNum].question);
                this.$set('ex', _.values(qaJson['q' + actNum].answer));
            }
            if(actNum == maxNum) {
                // 最後の問題になったら、NextボタンをOFFにする
                this.$set('disabled', 'disabled');
            }

            // 回答画面にデータを送信
            vue.sendDS(actNum, this.$get('ex'));

            // 画面切り替え
            vue.toScrn('s2');
        },

        // データストア
        sendDS: function(actNum, ex){
            DS_Quiz.send({
                DSactNum : actNum, // 問題数
                DSmaxNum : _.values(ex).length // 回答数
            });
            DS_Quiz.set(msgID, {DSactNum : actNum});
        },

        // カウント開始
        countStart: function(){
            clearInterval(timer);
            sec = countTime;
            vue.$set('nowTime', sec);
            timer = setInterval(vue.countDowon, intervalTime);

            El_audioBgm.pause();
            El_audioThinking.play();
        },

        // カウントダウン
        countDowon: function(){
            sec--;
            vue.$set('nowTime', sec);

            // 0秒になったらランキング画面に切り替え
            if(sec == 0) {
                clearInterval(timer);
                vue.rankingQ();
                sec = countTime;
                vue.$set('nowTime', sec);
            }
        }
    }
});


// --------------------------------------------------------
// Load
// --------------------------------------------------------
// 初回描画
vue.getJson();

</script>

</body>
</html>
